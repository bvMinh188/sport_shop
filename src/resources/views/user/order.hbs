<div class="container">
    <div class="row">
        <div class="col-md-5">
            <h3>Thông tin khách hàng</h3>
            <form>
                <div class="form-group">
                    <label for="customerName">Tên khách hàng</label>
                    <input type="text" class="form-control" id="customerName" value="{{userInfo.username}}" readonly>
                </div>
                <div class="form-group">
                    <label for="customerEmail">Email</label>
                    <input type="text" class="form-control" id="customerEmail" value="{{userInfo.email}}" readonly>
                </div>
                <div class="form-group">
                    <label for="customerPhone">Số điện thoại</label>
                    <input type="text" class="form-control" id="customerPhone" value="{{userInfo.phone}}" readonly>
                </div>
            </form>
        </div>

        <div class="col-md-7">
            <div class="delivery-address mb-4">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-map-marker-alt text-danger me-2"></i>
                        <h5 class="mb-0">Địa Chỉ Nhận Hàng</h5>
                    </div>
                    <button type="button" class="btn btn-link text-danger" id="changeAddress">Thay Đổi</button>
                </div>
                <div id="selectedAddress" class="selected-address p-3">
                    {{#if userInfo.addresses.[0]}}
                        <div class="current-address">
                            <div class="user-info">
                                <span class="name">{{userInfo.username}}</span>
                                <span class="divider">|</span>
                                <span class="phone">{{userInfo.phone}}</span>
                            </div>
                            <div class="address-text">
                                {{#with (findDefaultAddress userInfo.addresses)}}
                                    {{this.address}}
                                {{/with}}
                            </div>
                        </div>
                    {{else}}
                        <p class="text-muted">Chưa có địa chỉ</p>
                    {{/if}}
                </div>
            </div>

            <div class="modal fade" id="addressModal" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Địa Chỉ Của Tôi</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="address-list">
                                {{#each userInfo.addresses}}
                                <div class="address-item p-3 mb-2 border rounded">
                                    <div class="d-flex justify-content-between">
                                        <div class="address-info">
                                            <div class="user-info mb-2">
                                                <span class="name">{{../userInfo.username}}</span>
                                                <span class="divider">|</span>
                                                <span class="phone">{{../userInfo.phone}}</span>
                                            </div>
                                            <div class="address-text">
                                                {{this.address}}
                                                {{#if this.isDefault}}
                                                    <span class="default-badge">Mặc Định</span>
                                                {{/if}}
                                            </div>
                                        </div>
                                        <div class="address-actions">
                                            <button class="btn btn-outline-danger btn-sm select-address" 
                                                    data-address="{{this.address}}"
                                                    data-name="{{this.name}}">
                                                Chọn
                                            </button>
                                            {{#unless this.isDefault}}
                                                <button class="btn btn-outline-secondary btn-sm set-default-address" 
                                                        data-address-id="{{@index}}">
                                                    Đặt mặc định
                                                </button>
                                            {{/unless}}
                                        </div>
                                    </div>
                                </div>
                                {{/each}}
                            </div>

                            <button class="btn btn-outline-danger w-100 mt-3" id="addNewAddress">
                                <i class="fas fa-plus"></i> Thêm Địa Chỉ Mới
                            </button>

                            <div id="newAddressForm" class="mt-3" style="display: none;">
                                <div class="address-type mb-3">
                                    <div class="btn-group w-100" role="group">
                                        <input type="radio" class="btn-check" name="addressType" id="homeAddress" value="Nhà riêng" checked>
                                        <label class="btn btn-outline-danger" for="homeAddress">
                                            <i class="fas fa-home me-2"></i>Nhà riêng
                                        </label>
                                        
                                        <input type="radio" class="btn-check" name="addressType" id="officeAddress" value="Công ty">
                                        <label class="btn btn-outline-danger" for="officeAddress">
                                            <i class="fas fa-building me-2"></i>Công ty
                                        </label>
                                    </div>
                                </div>
                                <div class="form-group mb-3">
                                    <textarea class="form-control" id="newAddress" rows="3"
                                              placeholder="Nhập địa chỉ chi tiết (Số nhà, Đường, Phường/Xã, Quận/Huyện, Tỉnh/Thành phố)"></textarea>
                                </div>
                                <div class="form-check mb-3">
                                    <input type="checkbox" class="form-check-input" id="setAsDefault">
                                    <label class="form-check-label" for="setAsDefault">
                                        Đặt làm địa chỉ mặc định
                                    </label>
                                </div>
                                <div class="d-flex justify-content-end">
                                    <button type="button" class="btn btn-secondary me-2" id="cancelAdd">Hủy</button>
                                    <button type="button" class="btn btn-danger" id="saveAddress">Hoàn thành</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="order-info">
                <h3>Thông tin đơn hàng</h3>
                {{#if cart.length}}
                <table class="table mt-4">
                    <thead>
                        <tr>
                            <th scope="col">Tên sản phẩm</th>
                            <th scope="col"></th>
                            <th scope="col">Giá</th>
                            <th scope="col">Size</th>
                            <th scope="col">Số lượng</th>
                            <th scope="col">Sửa</th>
                            <th scope="col">Xóa</th>
                        </tr>
                    </thead>
                    <tbody>
                        {{#each cart}}
                            <tr>
                                <td class="name">{{this.name}}</td>
                                <td><img src="{{this.image}}" width="100px" height="100px"></td>
                                <td>{{formatPrince this.price}}</td>
                                <td>{{this.size}}</td>
                                <td>
                                    <span class="quantity">{{this.quantity}}</span>
                                    <input type="number" class="form-control quantity-input" value="{{this.quantity}}" min="0" style="display: none;" name="quantity">
                                </td>
                                <td>
                                    <button type="button" class="btn btn-success edit-btn">Sửa</button>
                                    <button type="button" class="btn btn-success update-btn" data-id="{{this._id}}" data-size="{{this.size}}" style="display: none;">Cập nhật</button>
                                </td>
                                <td>
                                    <button type="button" class="btn btn-danger delete-btn" data-id="{{this._id}}" data-size="{{this.size}}">Xóa</button>
                                </td>
                            </tr>
                        {{/each}}
                    </tbody>
                </table>
                {{else}}
                <div class="empty-cart text-center py-5">
                    <i class="fas fa-shopping-cart fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">Bạn vẫn chưa chọn sản phẩm nào để mua</h5>
                    <a href="/" class="btn btn-danger mt-3">Tiếp tục mua sắm</a>
                </div>
                {{/if}}
            </div>
        </div>

        <form id="orderForm">
            <div class="row mt-3">
                <div class="col-md-8">
                </div>
                <div class="col-md-4 d-flex flex-column justify-content-between align-items-end">
                    <div class="mb-3">
                        <h5>Tổng tiền: <span id="price">{{formatPrince tong}}</span></h5>
                    </div>
                    <button type="submit" class="btn btn-danger">Đặt hàng</button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Modal Xác Nhận Xóa -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Xác nhận xóa</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Bạn có chắc chắn muốn xóa sản phẩm này khỏi giỏ hàng?</p>
                <div class="product-info mt-3">
                    <div class="d-flex align-items-center">
                        <img id="deleteProductImage" src="" alt="" class="me-3" style="width: 80px; height: 80px; object-fit: cover;">
                        <div>
                            <h6 id="deleteProductName" class="mb-1"></h6>
                            <p class="mb-1">Size: <span id="deleteProductSize"></span></p>
                            <p class="mb-0">Số lượng: <span id="deleteProductQuantity"></span></p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-danger" id="confirmDelete">Xóa</button>
            </div>
        </div>
    </div>
</div>

<div class="message-container">
    <div class="message"></div>
</div>

<style>
    .message-container {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 9999;
        visibility: hidden;
        opacity: 0;
        transition: all 0.3s ease;
        min-width: 300px;
        text-align: center;
    }

    .message {
        padding: 15px 25px;
        border-radius: 8px;
        font-size: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        color: white;
        background-color: rgba(0, 0, 0, 0.8);
    }

    .message.success {
        background-color: rgba(40, 167, 69, 0.95);
    }

    .message.error {
        background-color: rgba(220, 53, 69, 0.95);
    }

    .message i {
        font-size: 20px;
    }

    .message span {
        font-weight: 500;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translate(-50%, calc(-50% + 20px));
        }
        to {
            opacity: 1;
            transform: translate(-50%, -50%);
        }
    }

    @keyframes fadeOut {
        from {
            opacity: 1;
            transform: translate(-50%, -50%);
        }
        to {
            opacity: 0;
            transform: translate(-50%, calc(-50% - 20px));
        }
    }

    .message-container.show {
        visibility: visible;
        opacity: 1;
        animation: fadeIn 0.3s ease forwards;
    }

    .message-container.hide {
        animation: fadeOut 0.3s ease forwards;
    }

    .product-info {
        background-color: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
    }

    #deleteConfirmModal .modal-content {
        border-radius: 8px;
        border: none;
    }

    #deleteConfirmModal .modal-header {
        border-bottom: 1px solid #dee2e6;
        background-color: #f8f9fa;
    }

    #deleteConfirmModal .modal-footer {
        border-top: 1px solid #dee2e6;
        padding: 1rem;
    }

    #deleteConfirmModal .btn-danger {
        background-color: #dc3545;
        border-color: #dc3545;
    }

    #deleteConfirmModal .btn-danger:hover {
        background-color: #c82333;
        border-color: #bd2130;
    }
</style>

<script>
$(document).ready(function(){
    let selectedAddressValue = '';  // Biến để lưu địa chỉ đã chọn

    // Tự động set địa chỉ mặc định khi trang load
    const defaultAddressElement = $('#selectedAddress .address-text');
    if (defaultAddressElement.length) {
        selectedAddressValue = defaultAddressElement.text().trim();
    }

    $('.edit-btn').click(function(){
        var row = $(this).closest('tr');
        row.find('.quantity').hide();
        row.find('.quantity-input').show();
        $(this).hide();
        row.find('.update-btn').show();
    });

    $('.update-btn').click(function() {
        var row = $(this).closest('tr');
        var productId = $(this).data('id');
        var size = $(this).data('size');
        var newQuantity = row.find('.quantity-input').val();

        if (newQuantity && newQuantity.trim() !== '') {
            if (parseInt(newQuantity) === 0) {
                deleteProduct(productId, size)
            } else {
                $.ajax({
                    url: `/update-order/${productId}`,
                    method: 'POST',
                    data: {
                        size: size,
                        quantity: newQuantity
                    },
                    success: function(response) {
                        if (response.message === 'Cập nhật giỏ hàng thành công') {
                            showMessage('Cập nhật giỏ hàng thành công', 'success');
                            setTimeout(() => window.location.reload(), 2500);
                        } else {
                            showMessage(response.message, 'error');
                        }
                    },
                    error: function() {
                        showMessage('Đã xảy ra lỗi khi cập nhật số lượng', 'error');
                    }
                });
            }
        } else {
            showMessage('Vui lòng nhập số lượng hợp lệ', 'error');
        }
    });

    let deleteProductData = null;

    $('.delete-btn').click(function() {
        const row = $(this).closest('tr');
        deleteProductData = {
            id: $(this).data('id'),
            size: $(this).data('size'),
            name: row.find('.name').text(),
            image: row.find('img').attr('src'),
            quantity: row.find('.quantity').text()
        };

        // Cập nhật thông tin sản phẩm trong modal
        $('#deleteProductName').text(deleteProductData.name);
        $('#deleteProductSize').text(deleteProductData.size);
        $('#deleteProductQuantity').text(deleteProductData.quantity);
        $('#deleteProductImage').attr('src', deleteProductData.image);

        // Hiển thị modal
        $('#deleteConfirmModal').modal('show');
    });

    $('#confirmDelete').click(function() {
        if (!deleteProductData) return;

        const btn = $(this);
        const originalText = btn.text();
        btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Đang xử lý...');

        $.ajax({
            url: `/delete-cart/${deleteProductData.id}?size=${deleteProductData.size}`,
            method: 'DELETE',
            success: function(response) {
                $('#deleteConfirmModal').modal('hide');
                showMessage('Đã xóa sản phẩm ra khỏi giỏ hàng', 'success');
                setTimeout(() => window.location.reload(), 2000);
            },
            error: function(xhr) {
                const message = xhr.responseJSON?.message || 'Đã xảy ra lỗi khi xóa sản phẩm';
                showMessage(message, 'error');
            },
            complete: function() {
                btn.prop('disabled', false).text(originalText);
            }
        });
    });

    $('#changeAddress').click(function() {
        $('#addressModal').modal('show');
    });

    $('#addNewAddress').click(function() {
        $(this).hide();
        $('#newAddressForm').show();
    });

    $('#cancelAdd').click(function() {
        $('#newAddressForm').hide();
        $('#addNewAddress').show();
        $('#addressName').val('');
        $('#newAddress').val('');
        $('#setAsDefault').prop('checked', false);
        window.location.reload();
    });

    $('#saveAddress').click(function() {
        const addressType = $('input[name="addressType"]:checked').val();
        const newAddress = $('#newAddress').val().trim();
        const setAsDefault = $('#setAsDefault').is(':checked');

        if (!newAddress) {
            showMessage('Vui lòng nhập địa chỉ chi tiết', 'error');
            $('#newAddress').focus();
            return;
        }

        const saveButton = $(this);
        saveButton.prop('disabled', true)
            .html('<i class="fas fa-spinner fa-spin"></i> Đang lưu...');

        console.log('Request data:', {
            name: addressType,
            address: newAddress,
            isDefault: setAsDefault
        });

        $.ajax({
            url: '/add-address',
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            data: JSON.stringify({
                name: addressType,
                address: newAddress,
                isDefault: setAsDefault
            }),
            success: function(response) {
                console.log('Response:', response);

                if (response.success) {
                    const newAddressHtml = `
                        <div class="address-item p-3 mb-2 border rounded">
                            <div class="d-flex justify-content-between">
                                <div class="address-info">
                                    <div class="user-info mb-2">
                                        <span class="name">${$('#customerName').val()}</span>
                                        <span class="divider">|</span>
                                        <span class="phone">${$('#customerPhone').val()}</span>
                                    </div>
                                    <div class="address-text">
                                        <div class="address-type-badge ${addressType === 'Nhà riêng' ? 'home' : 'office'}">
                                            <i class="fas ${addressType === 'Nhà riêng' ? 'fa-home' : 'fa-building'} me-1"></i>
                                            ${addressType}
                                        </div>
                                        ${newAddress}
                                        ${setAsDefault ? '<span class="default-badge ms-2">Mặc Định</span>' : ''}
                                    </div>
                                </div>
                                <div class="address-actions">
                                    <button class="btn btn-outline-danger btn-sm select-address" 
                                            data-address="${newAddress}"
                                            data-name="${addressType}">
                                        Chọn
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    $('.address-list').prepend(newAddressHtml);
                    
                    $('#newAddress').val('');
                    $('#setAsDefault').prop('checked', false);
                    $('#newAddressForm').hide();
                    $('#addNewAddress').show();

                    if (setAsDefault || !$('#selectedAddress .current-address').length) {
                        updateSelectedAddress(newAddress, addressType);
                    }
                    
                    showMessage('Thêm địa chỉ thành công', 'success');
                    $('#addressModal').modal('hide');
                } else {
                    showMessage(response.message || 'Có lỗi xảy ra', 'error');
                }
            },
            error: function(xhr, status, error) {
                console.error('Error details:', {
                    status: status,
                    error: error,
                    response: xhr.responseText
                });
                showMessage('Có lỗi xảy ra khi thêm địa chỉ. Vui lòng thử lại sau.', 'error');
            },
            complete: function() {
                saveButton.prop('disabled', false).text('Hoàn thành');
            }
        });
    });

    $(document).on('click', '.select-address', function() {
        const address = $(this).data('address');
        selectedAddressValue = address;  // Lưu địa chỉ thuần túy
        updateSelectedAddress(address);
        $('#addressModal').modal('hide');
    });

    function updateSelectedAddress(address, type) {
        $('#selectedAddress').html(`
            <div class="current-address">
                <div class="user-info">
                    <span class="name">${$('#customerName').val()}</span>
                    <span class="divider">|</span>
                    <span class="phone">${$('#customerPhone').val()}</span>
                </div>
                <div class="address-text">
                    ${address}
                </div>
            </div>
        `);
    }

    $("#orderForm").submit(function(event) {
        event.preventDefault();
        
        if (!$('.table').length) {
            showMessage('Bạn vẫn chưa chọn sản phẩm nào để mua hàng', 'error');
            return;
        }
        
        if (!selectedAddressValue) {
            showMessage('Vui lòng chọn địa chỉ giao hàng', 'error');
            return;
        }

        const price = $("#price").text();
        const submitBtn = $(this).find('button[type="submit"]');
        const originalText = submitBtn.text();
        submitBtn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Đang xử lý...');

        $.ajax({
            url: "/checkout",
            method: "POST",
            data: {
                address: selectedAddressValue,
                price: price
            },
            success: function(response) {
                if (response.message === 'success') {
                    showMessage('Đặt hàng thành công', 'success');
                    setTimeout(() => {
                        window.location.href = "/account";
                    }, 1000);
                } else {
                    showMessage(response.message || 'Đã xảy ra lỗi', 'error');
                    submitBtn.prop('disabled', false).text(originalText);
                }
            },
            error: function(xhr) {
                showMessage(xhr.responseJSON?.message || 'Đã xảy ra lỗi trong quá trình đặt hàng', 'error');
                submitBtn.prop('disabled', false).text(originalText);
            }
        });
    });

    // Xử lý nút đặt địa chỉ mặc định
    $(document).on('click', '.set-default-address', function(e) {
        e.preventDefault();
        const addressId = $(this).data('address-id');
        
        $.ajax({
            url: '/set-default-address',
            method: 'POST',
            data: { addressId: addressId },
            success: function(response) {
                if (response.success) {
                    showMessage('Đã đặt địa chỉ mặc định', 'success');
                    window.location.reload();
                } else {
                    showMessage(response.message || 'Có lỗi xảy ra', 'error');
                }
            },
            error: function() {
                showMessage('Có lỗi xảy ra khi đặt địa chỉ mặc định', 'error');
            }
        });
    });

    function showMessage(message, type = 'success') {
        const messageContainer = $('.message-container');
        const messageElement = $('.message');
        
        // Thêm icon cho message
        const icon = type === 'success' ? 'check-circle' : 'exclamation-circle';
        messageElement.html(`
            <i class="fas fa-${icon}"></i>
            <span>${message}</span>
        `);
        
        messageElement.removeClass('success error').addClass(type);
        messageContainer.removeClass('hide').addClass('show');
        
        setTimeout(() => {
            messageContainer.removeClass('show').addClass('hide');
        }, 2000);
    }
});
</script>
